---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# dlptools

dlptools will help with basic file manipulation of DLP pipeline out and adding of genomic features to read bins for filtering and classification of changes. Also included are a few standard plots that are commonly made.

## Installation

You can install the development version of dlptools from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("molonc/dlptools")
```

## Common Analysis Tasks

These are a few steps that are often taken to start a DLP analysis.

```{r example}
library(dlptools)
## basic example code

# TODO: examples
```



## Plotting Trees and Heatmaps

A common plot from a DLP analysis is to build a tree with some method ([sitka](https://github.com/molonc/sitka_wrapper/tree/main), or hdbscan) and then plot it next to a heatmap of read state calls. The function `dlptools::create_tree_copynumber_heatmap()` is designed to do just that. It is a wrapper around several independent steps and the full code with individual functions is available in the repo at `R/plot_tree_heatmap.R`.

The point of the plot is to bring together a tree, with clone labels, and state calls. If you have other annotations, those can be added too.

Here we'll walk through plot creation with HDBScan. This requires installing [signals](https://github.com/shahcompbio/signals) in addition to this package.

```{r}
library(dlptools)
library(signals)
library(dplyr)

# import the reads data
dlp_dir <- "/projects/molonc/scratch/bfurman/dlp_testdata/"
# dir just has a directory with DLP data, see README.md for how to download
reads <- dlptools::import_dlp_files(dlp_dir, "reads")

# lets also load the cell metrics
metrics <- dlptools::import_dlp_files(dlp_dir, "metrics")

# and we can combine with the reads data to associate metric with the individual
# cells
reads <- dplyr::left_join(
  reads, metrics,
  by = "cell_id",
)

# BEN! the filtering I do below needs to be corrected, it's a mix of read_bin and
# cell level filtering, and that should be teased apart, though it probably leads
# to the same answer.

# many columns of data available. Here is a subset
reads[1:4, 2:10]
```

Now typically we would want to do some filtering, this would be project specific, so this is just an example of some ideas to consider:

```{r}
# lets add masked regions based on our standard masking file
reads <- dlptools::mark_mask_regions(reads, mask_f = "meta_data/blacklist_2023.07.17.txt")

# some basic filtering
reads_f <- reads %>%
  dplyr::filter(
    quality > 0.75 & # cells of high RF quality
      map > 0 & # read bins that mapped to good regions
      gc != -1 & # ones that have undergone a GC correction
      !mask & # bins that fall outside of masked regions
      !is_control & # non-control cells
      cell_call == "C1" & # just live cells
      !is_s_phase & # that are not estimated to be in S-phase
      total_mapped_reads >= 250000 # and have a reasonable amount of reads
  )

# if you see an error like:
# An error occurred in umap calculation: function 'as_cholmod_sparse' not
# provided by package 'Matrix'
# you might need to install some older package versions
# remotes::install_version("Matrix", version = "1.6-1")
# install.packages("irlba", type = "source")
# https://github.com/bwlewis/irlba/issues/70
clusters <- signals::umap_clustering(
  reads_f,
  minPts = 50, field = "state"
)

# need to prep the reads data
reads_f_wide <- convert_long_reads_to_wide(reads_f)

# now we can make the plot
dlptools::create_tree_copynumber_heatmap(
  phylo_tree = clusters$tree,
  states_df = reads_f_wide,
  clones_df = clusters$clustering,
  # can save direct to file by adding:
  # file_name="example_hdbscan.png"
)

# lets say we had some annotation we wanted to add too, these are done by
# matching sample IDs in cell_id names.
# this could be read froma file with dlptools::import_annotations_df()
# but will just prep this example by hand
anno_df <- tibble(
  # bit of a boring example, because we only have one sample and one library
  sample_id = c("AT21614"),
  passage = c("p3"),
  somthing_else = c("featureA")
)

dlptools::create_tree_copynumber_heatmap(
  phylo_tree = clusters$tree,
  states_df = reads_f_wide,
  clones_df = clusters$clustering,
  annos_df = anno_df
)
```

